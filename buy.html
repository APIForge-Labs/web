<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comprar Licencia — APIForge Labs</title>
  <meta name="description" content="Compra de licencias — APIForge Labs" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo">AF<span>Labs</span></div>
      <div class="titles">
        <h1>APIForge Labs</h1>
        <p class="muted">Comprar licencias</p>
      </div>
    </div>
    <nav>
      <a href="index.html">Inicio</a>
      <a href="buy.html" class="btn primary">Comprar</a>
    </nav>
  </header>

  <main class="container">
    <section class="buy-area">
      <h2>Compra tu licencia</h2>
      <p class="muted">Precio por licencia: <strong>USD 35.65</strong>. Introduce el correo al que quieres que se envíe la factura y la clave.</p>

      <form id="buyForm" onsubmit="return false;" autocomplete="off">
        <label for="email">Correo electrónico (destino):</label>
        <input type="email" id="email" placeholder="tuemail@ejemplo.com" required />

        <label for="qty">Cantidad de licencias:</label>
        <input type="number" id="qty" value="1" min="1" />

        <label for="issueDate">Fecha de emisión:</label>
        <input type="datetime-local" id="issueDate" value="" />

        <label for="method">Método permitido:</label>
        <select id="method">
          <option value="POST" selected>POST</option>
          <option value="GET">GET</option>
        </select>

        <div class="crypto-choices">
          <label><input type="radio" name="crypto" value="USDT" checked> USDT (BEP20)</label>
        </div>

        <div class="actions">
          <button class="btn primary" onclick="simulatePurchase()">Proceder</button>
          <button class="btn" onclick="generateInvoiceOnly()">Descargar factura (HTML)</button>
          <button class="btn" onclick="downloadInvoicePDF()">Descargar factura (PDF)</button>
        </div>
      </form>

      <div id="result" class="result" style="display:none"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div>APIForge Labs — © <span id="year2"></span></div>
    <div class="muted small">Documento preparado para evaluación.</div>
  </footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.getElementById('year2').textContent = new Date().getFullYear();
document.getElementById('issueDate').value = new Date().toISOString().slice(0,16);

function generarLicencia() {
  const parts = [];
  for (let i=0;i<3;i++){
    parts.push(Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(2,6));
  }
  return 'AF-LIC-' + parts.join('-');
}

function fechaSimuladaVisible() {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  d.setHours(18,0,0,0);
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,'0');
  const minu = String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} - ${hh}:${minu}`;
}

function buildInvoiceHTML(invId, licenses, email, unit, total, issuedVisible, method) {
  let itemsHtml = '';
  licenses.forEach((lic, index) => {
    itemsHtml += `<tr>
      <td>Licencia APIForge Premium #${index + 1} — Permanente, un solo uso ${method} endpoint</td>
      <td>1</td>
      <td>USD ${unit.toFixed(2)}</td>
      <td class="right">USD ${unit.toFixed(2)}</td>
    </tr>`;
  });

  let licenseHtml = '';
  licenses.forEach((lic, index) => {
    licenseHtml += `<p><strong>Licencia #${index + 1}:</strong> ${lic}</p>`;
  });

  return `<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Factura ${invId}</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;padding:20px;color:#222}
.box{max-width:750px;margin:0 auto;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
header{background:linear-gradient(90deg,#0061ff,#00d4ff);color:#fff;padding:16px}
header h1{margin:0;font-size:18px}
.content{padding:18px}
.meta{display:flex;justify-content:space-between;gap:12px;font-size:13px;color:#555}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
th{background:#f7fbff}
.right{text-align:right}
.total{font-weight:800}
.license{background:#f0f7ff;border-left:4px solid #0061ff;padding:12px;margin-top:12px;font-family:monospace}
</style>
</head>
<body>
<div class="box">
<header><h1>APIForge Labs — FACTURA <small style="display:block;font-weight:400">ID: ${invId}</small></h1></header>
<div class="content">
  <div class="meta"><div><strong>Facturado a:</strong><br>${email}</div><div><strong>Fecha emisión:</strong><br>${issuedVisible}</div></div>
  <table>
    <thead><tr><th>Concepto</th><th>Cant.</th><th>Unit.</th><th class="right">Total</th></tr></thead>
    <tbody>
      ${itemsHtml}
    </tbody>
    <tfoot>
      <tr><td colspan="3" class="right">Subtotal</td><td class="right">USD ${total.toFixed(2)}</td></tr>
      <tr><td colspan="3" class="right">Impuestos</td><td class="right">USD 0.00</td></tr>
      <tr><td colspan="3" class="right total">TOTAL</td><td class="right total">USD ${total.toFixed(2)}</td></tr>
    </tfoot>
  </table>
  <div class="license">
    ${licenseHtml}
    <p><strong>Producto:</strong> APIForge Premium</p>
    <p><strong>Tipo de uso:</strong> Permanente, un solo uso</p>
    <p><strong>Método permitido:</strong> ${method} (cualquier endpoint)</p>
    <p><strong>Clave API:</strong> X-AF-KEY de cada licencia arriba</p>
    <p><strong>Pago:</strong> USDT (BEP20)</p>
    <p><strong>Dirección envío:</strong> 0x4c47F778F189B8c40691205C6E2c235Ec59e6D4b</p>
  </div>
</div>
</div>
</body>
</html>`;
}

function downloadBlob(filename, content, mime='text/html') {
  const blob = new Blob([content], {type: mime + ';charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

function simulatePurchase() {
  const email = document.getElementById('email').value.trim();
  if (!email) { alert('Introduce un correo válido'); return; }

  const qty = parseInt(document.getElementById('qty').value) || 1;
  const unit = 35.65;
  const total = qty * unit;
  const method = document.getElementById('method').value;

  const licenses = [];
  for (let i = 0; i < qty; i++) licenses.push(generarLicencia());

  const invId = 'INV-' + new Date().getTime().toString().slice(-8);

  // Fecha elegida por el usuario
  const dateInput = document.getElementById('issueDate').value;
  let issuedVisible;
  if (dateInput) {
    const d = new Date(dateInput);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,'0');
    const minu = String(d.getMinutes()).padStart(2,'0');
    issuedVisible = `${dd}/${mm}/${yyyy} - ${hh}:${minu}`;
  } else {
    issuedVisible = fechaSimuladaVisible();
  }

  const invoiceHtml = buildInvoiceHTML(invId, licenses, email, unit, total, issuedVisible, method);

  document.getElementById('result').style.display = 'block';
  document.getElementById('result').innerHTML = `<p><strong>Compra procesada.</strong></p>
    <p>Se generaron ${qty} licencia(s) con método ${method}.</p>
    <p>Factura total: <strong>USD ${total.toFixed(2)}</strong></p>
    <p>La factura está disponible para descarga.</p>
    <p><button class="btn" onclick="downloadInvoice()">Descargar factura (HTML)</button>
    <button class="btn" onclick="downloadInvoicePDF()">Descargar factura (PDF)</button></p>`;

  window._lastInvoice = {invoiceHtml, invId, licenses, email, qty, unit, total, issuedVisible, method};
}

function downloadInvoice() {
  if (!window._lastInvoice) return alert('Genera primero la factura.');
  downloadBlob(`invoice-${window._lastInvoice.invId}.html`, window._lastInvoice.invoiceHtml, 'text/html');
}

function generateInvoiceOnly() {
  const email = document.getElementById('email').value.trim() || 'usuario@ejemplo.com';
  const qty = parseInt(document.getElementById('qty').value) || 1;
  const unit = 35.65;
  const total = qty * unit;
  const method = document.getElementById('method').value;
  const licenses = [];
  for (let i = 0; i < qty; i++) licenses.push(generarLicencia());
  const invId = 'INV-' + new Date().getTime().toString().slice(-8);

  const dateInput = document.getElementById('issueDate').value;
  let issuedVisible;
  if (dateInput) {
    const d = new Date(dateInput);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,'0');
    const minu = String(d.getMinutes()).padStart(2,'0');
    issuedVisible = `${dd}/${mm}/${yyyy} - ${hh}:${minu}`;
  } else {
    issuedVisible = fechaSimuladaVisible();
  }

  const invoiceHtml = buildInvoiceHTML(invId, licenses, email, unit, total, issuedVisible, method);
  downloadBlob(`invoice-${invId}.html`, invoiceHtml, 'text/html');
}

async function downloadInvoicePDF() {
  if (!window._lastInvoice) return alert('Genera primero la factura.');
  const container = document.createElement('div');
  container.innerHTML = window._lastInvoice.invoiceHtml;
  container.style.width = '750px';
  container.style.padding = '0';
  container.style.background = '#fff';
  document.body.appendChild(container);

  const canvas = await html2canvas(container, {scale: 2});
  const imgData = canvas.toDataURL('image/png');

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'pt', 'a4');
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const imgWidth = pdfWidth - 40;
  const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
  pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
  pdf.save(`invoice-${window._lastInvoice.invId}.pdf`);

  container.remove();
}

(function prefillFromQuery(){
  const params = new URLSearchParams(location.search);
  const p = params.get('prod') || '';
  if (p) document.getElementById('product').value = decodeURIComponent(p);
})();
</script>
</body>
</html>
